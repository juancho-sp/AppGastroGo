{% extends 'base.html' %}
{% load static %}

{% block navbar %}
<nav class="container p-3">
    <div class="nav nav-tabs" id="nav-tab" role="tablist">
        <button class="nav-link active enlace"
                id="nav-NuevoPedido-tab"
                data-url="{% url 'tab_nuevo_pedido' %}"
                data-bs-toggle="tab"
                data-bs-target="#nav-NuevoPedido"
                type="button" role="tab">
            Nuevo pedido
        </button>
        <button class="nav-link enlace"
                id="nav-DetallePedido-tab"
                data-url="{% url 'tab_detalle_pedido' %}"
                data-bs-toggle="tab"
                data-bs-target="#nav-DetallePedido"
                type="button" role="tab">
            Consultar ventas
        </button>
        <button class="nav-link enlace"
                id="nav-EstadoPedidos-tab"
                data-url="{% url 'tab_estado_pedidos' %}"
                data-bs-toggle="tab"
                data-bs-target="#nav-EstadoPedidos"
                type="button" role="tab">
            Estado pedidos
        </button>
    </div>
</nav>
{% endblock %}

{% block titulo_principal %}Caja{% endblock %}

{% block contenido %}
{% for message in messages %}
    {% if message.level == DEFAULT_MESSAGE_LEVELS.ERROR %}
        <div class="alert alert-danger alert-dismissible-auto">{{ message }}</div>
    {% elif message.level == DEFAULT_MESSAGE_LEVELS.SUCCESS %}
        <div class="alert alert-success alert-dismissible-auto">{{ message }}</div>
    {% elif message.level == DEFAULT_MESSAGE_LEVELS.WARNING %}
        <div class="alert alert-warning alert-dismissible-auto">{{ message }}</div>
    {% endif %}
{% endfor %}

<div class="tab-content container mb-3" id="nav-tabContent">
    <div class="tab-pane fade show active" id="nav-NuevoPedido" role="tabpanel"></div>
    <div class="tab-pane fade" id="nav-DetallePedido" role="tabpanel"></div>
    <div class="tab-pane fade" id="nav-EstadoPedidos" role="tabpanel"></div>
    <div class="tab-pane fade" id="nav-BalanceCaja" role="tabpanel"></div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}

<script>
document.addEventListener("DOMContentLoaded", function () {
    function loadTabContent(button) {
        const url = button.getAttribute("data-url");
        const target = button.getAttribute("data-bs-target");

        // Tomar los par√°metros de la URL actual (fecha, hora_inicio, hora_fin)
        const searchParams = new URLSearchParams(window.location.search);
        const fullUrl = url + "?" + searchParams.toString();

        if (url && target) {
            fetch(fullUrl)
                .then(response => {
                    if (!response.ok) throw new Error("Error al cargar la pesta√±a");
                    return response.text();
                })
                .then(html => {
                    document.querySelector(target).innerHTML = html;

                    // Activar l√≥gica de "Nuevo Pedido" si es esa pesta√±a
                    if (target === '#nav-NuevoPedido') {
                        activarFormularioNuevoPedido();
                    }

                    if (target === '#nav-EstadoPedidos') {
                        activarBotonesEstadoPedidos();
                    }
                })
                .catch(error => {
                    document.querySelector(target).innerHTML = '<div class="alert alert-danger">Error al cargar contenido.</div>';
                    console.error(error);
                });
        }
    }

    // Activar al cargar por defecto
    const abrirTab = "{{ abrir_tab|default:'' }}";
    const tabButton = abrirTab
        ? document.querySelector(`#nav-tab .nav-link[data-bs-target="#nav-${abrirTab|capfirst}"]`)
        : document.querySelector("#nav-tab .nav-link.active");

    if (tabButton) {
        tabButton.classList.add("active");
        document.querySelector(tabButton.getAttribute("data-bs-target")).classList.add("show", "active");
        loadTabContent(tabButton);
    }

    // Cargar pesta√±as al hacer clic
    document.querySelectorAll('#nav-tab .nav-link').forEach(button => {
        button.addEventListener("click", function () {
            loadTabContent(this);
        });
    });

    // Funci√≥n para activar formulario de nuevo pedido
    function activarFormularioNuevoPedido() {
        const addButton = document.getElementById('add-form');
        if (!addButton) return;

        const formTable = document.querySelector('#formset-table tbody');
        const totalForms = document.getElementById('id_form-TOTAL_FORMS');
        const emptyFormHtml = document.getElementById('empty-form-template').innerHTML;
        const totalPedidoSpan = document.getElementById('total-pedido');

        
        const precioMap = JSON.parse(document.getElementById('platos-json').textContent);

        function recalcularTotales() {
            let total = 0;
            document.querySelectorAll('.form-row').forEach(function (row) {
                const inputNombre = row.querySelector('.plato-input');
                const inputCantidad = row.querySelector('.cantidad-input');
                const spanSubtotal = row.querySelector('.subtotal');

                const nombre = inputNombre?.value || '';
                const cantidad = parseInt(inputCantidad?.value) || 0;
                const precio = parseFloat(precioMap[nombre]) || 0;

                const subtotal = precio * cantidad;
                spanSubtotal.textContent = subtotal.toLocaleString('en-US', {
                    minimumFractionDigits: 1,
                    maximumFractionDigits: 1
                });
                total += subtotal;
            });
            totalPedidoSpan.textContent = total.toLocaleString('en-US', {
                minimumFractionDigits: 1,
                maximumFractionDigits: 1
            });
        }

        addButton.addEventListener('click', function () {
            const formIndex = parseInt(totalForms.value);
            const newFormHtml = emptyFormHtml.replace(/__prefix__/g, formIndex);
            const tempDiv = document.createElement('tbody');
            tempDiv.innerHTML = newFormHtml;
            formTable.appendChild(tempDiv.firstElementChild);
            totalForms.value = formIndex + 1;
            recalcularTotales();
        });

        formTable.addEventListener('input', recalcularTotales);
        recalcularTotales();
    }
});
</script>

<script>
// Esta funci√≥n se llama despu√©s de cargar la pesta√±a "Estado pedidos"
function asignarEventosBotones() {
    console.log("üéØ Asignando eventos a botones...");

    // Bot√≥n ENTREGAR
    document.querySelectorAll(".cambiar-estado").forEach(btn => {
        btn.addEventListener("click", function () {
            console.log("‚úÖ Click en bot√≥n ENTREGAR");
            const id = this.dataset.id;
            const estado = this.dataset.estado;

            if (!confirm("¬øEst√°s seguro de marcar este pedido como ENTREGADO?")) {
                return;
            }

            fetch("{% url 'cambiar_estado_pedido' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: `pedido_id=${id}&nuevo_estado=${estado}`
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // Eliminar pedido de la tabla de pendientes
                    document.getElementById(`pedido-${id}`).remove();
                    // Reemplazar lista de finalizados
                    document.getElementById("tabla-finalizados").innerHTML = data.finalizados_html;
                    // Reasignar eventos a los nuevos botones
                    asignarEventosBotones();
                } else {
                    alert("Error al cambiar estado");
                }
            });
        });
    });

    // Bot√≥n CANCELAR (abre modal)
    document.querySelectorAll(".cancelar-pedido").forEach(btn => {
        btn.addEventListener("click", function () {
            const id = this.dataset.id;
            document.getElementById("pedido_id_cancelar").value = id;
            const modal = new bootstrap.Modal(document.getElementById('modalCancelar'));
            modal.show();
        });
    });

    // Submit del formulario del modal (evita m√∫ltiples registros)
    const formCancelar = document.getElementById("formCancelar");
    if (formCancelar && !formCancelar.dataset.eventoAgregado) {
        formCancelar.addEventListener("submit", function (e) {
            e.preventDefault();
            const id = document.getElementById("pedido_id_cancelar").value;
            const nota = document.getElementById("nota_cancelacion").value;

            fetch("{% url 'cambiar_estado_pedido' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                    "Content-Type": "application/x-www-form-urlencoded"
                },
                body: `pedido_id=${id}&nuevo_estado=cancelado&nota=${encodeURIComponent(nota)}`
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(`pedido-${id}`).remove();
                    bootstrap.Modal.getInstance(document.getElementById('modalCancelar')).hide();
                    document.getElementById("tabla-finalizados").innerHTML = data.finalizados_html;
                    asignarEventosBotones();
                } else {
                    alert("Error al cancelar");
                }
            });
        });
        formCancelar.dataset.eventoAgregado = "true";  // evita agregarlo dos veces
    }
}
</script>

<script>
// L√≥gica para cargar pesta√±as con fetch
document.addEventListener("DOMContentLoaded", function () {
    function loadTabContent(button) {
        const url = button.getAttribute("data-url");
        const target = button.getAttribute("data-bs-target");

        if (url && target) {
            fetch(url)
                .then(response => {
                    if (!response.ok) throw new Error("Error al cargar la pesta√±a");
                    return response.text();
                })
                .then(html => {
                    document.querySelector(target).innerHTML = html;

                    if (target === '#nav-EstadoPedidos') {
                        // Esperamos un poco a que el contenido se inyecte
                        setTimeout(asignarEventosBotones, 100);
                    }
                })
                .catch(error => {
                    document.querySelector(target).innerHTML = '<div class="alert alert-danger">Error al cargar contenido.</div>';
                    console.error(error);
                });
        }
    }

    // Activar la pesta√±a inicial
    const tabButton = document.querySelector("#nav-tab .nav-link.active");
    if (tabButton) {
        loadTabContent(tabButton);
    }

    // Asignar eventos para cambio de pesta√±a
    document.querySelectorAll('#nav-tab .nav-link').forEach(button => {
        button.addEventListener("click", function () {
            loadTabContent(this);
        });
    });
});
</script>


{% endblock %}
