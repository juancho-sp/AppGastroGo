{% extends 'base.html' %}
{% load static %}

{% block navbar %}
<nav class="container p-3">
    <div class="nav nav-tabs" id="nav-tab" role="tablist">
        <button class="nav-link active enlace"
                id="nav-NuevoPedido-tab"
                data-url="{% url 'tab_nuevo_pedido' %}"
                data-bs-toggle="tab"
                data-bs-target="#nav-NuevoPedido"
                type="button" role="tab">
            Nuevo pedido
        </button>
        <button class="nav-link enlace"
                id="nav-DetallePedido-tab"
                data-url="{% url 'tab_detalle_pedido' %}"
                data-bs-toggle="tab"
                data-bs-target="#nav-DetallePedido"
                type="button" role="tab">
            Consultar ventas
        </button>
        <button class="nav-link enlace"
                id="nav-EstadoPedidos-tab"
                data-url="{% url 'tab_estado_pedidos' %}"
                data-bs-toggle="tab"
                data-bs-target="#nav-EstadoPedidos"
                type="button" role="tab">
            Estado pedidos
        </button>
    </div>
</nav>
{% endblock %}

{% block titulo_principal %}Caja{% endblock %}

{% block contenido %}
{% for message in messages %}
    {% if message.level == DEFAULT_MESSAGE_LEVELS.ERROR %}
        <div class="alert alert-danger alert-dismissible-auto">{{ message }}</div>
    {% elif message.level == DEFAULT_MESSAGE_LEVELS.SUCCESS %}
        <div class="alert alert-success alert-dismissible-auto">{{ message }}</div>
    {% elif message.level == DEFAULT_MESSAGE_LEVELS.WARNING %}
        <div class="alert alert-warning alert-dismissible-auto">{{ message }}</div>
    {% endif %}
{% endfor %}

<div class="tab-content container mb-3" id="nav-tabContent">
    <div class="tab-pane fade show active" id="nav-NuevoPedido" role="tabpanel"></div>
    <div class="tab-pane fade" id="nav-DetallePedido" role="tabpanel"></div>
    <div class="tab-pane fade" id="nav-EstadoPedidos" role="tabpanel"></div>
    <div class="tab-pane fade" id="nav-BalanceCaja" role="tabpanel"></div>
</div>
{% endblock %}

{% block scripts %}
{{ block.super }}

<script>
document.addEventListener("DOMContentLoaded", function () {
    function loadTabContent(button) {
        const url = button.getAttribute("data-url");
        const target = button.getAttribute("data-bs-target");

        // Tomar los parámetros de la URL actual (fecha, hora_inicio, hora_fin)
        const searchParams = new URLSearchParams(window.location.search);
        const fullUrl = url + "?" + searchParams.toString();

        if (url && target) {
            fetch(fullUrl)
                .then(response => {
                    if (!response.ok) throw new Error("Error al cargar la pestaña");
                    return response.text();
                })
                .then(html => {
                    document.querySelector(target).innerHTML = html;

                    // Activar lógica de "Nuevo Pedido" si es esa pestaña
                    if (target === '#nav-NuevoPedido') {
                        activarFormularioNuevoPedido();
                    }
                })
                .catch(error => {
                    document.querySelector(target).innerHTML = '<div class="alert alert-danger">Error al cargar contenido.</div>';
                    console.error(error);
                });
        }
    }

    // Activar al cargar por defecto
    const abrirTab = "{{ abrir_tab|default:'' }}";
    const tabButton = abrirTab
        ? document.querySelector(`#nav-tab .nav-link[data-bs-target="#nav-${abrirTab|capfirst}"]`)
        : document.querySelector("#nav-tab .nav-link.active");

    if (tabButton) {
        tabButton.classList.add("active");
        document.querySelector(tabButton.getAttribute("data-bs-target")).classList.add("show", "active");
        loadTabContent(tabButton);
    }

    // Cargar pestañas al hacer clic
    document.querySelectorAll('#nav-tab .nav-link').forEach(button => {
        button.addEventListener("click", function () {
            loadTabContent(this);
        });
    });

    // Función para activar formulario de nuevo pedido
    function activarFormularioNuevoPedido() {
        const addButton = document.getElementById('add-form');
        if (!addButton) return;

        const formTable = document.querySelector('#formset-table tbody');
        const totalForms = document.getElementById('id_form-TOTAL_FORMS');
        const emptyFormHtml = document.getElementById('empty-form-template').innerHTML;
        const totalPedidoSpan = document.getElementById('total-pedido');
        const precioMap = JSON.parse(document.getElementById('platos-json').textContent);

        function recalcularTotales() {
            let total = 0;
            document.querySelectorAll('.form-row').forEach(function (row) {
                const inputNombre = row.querySelector('.plato-input');
                const inputCantidad = row.querySelector('.cantidad-input');
                const spanSubtotal = row.querySelector('.subtotal');

                const nombre = inputNombre?.value || '';
                const cantidad = parseInt(inputCantidad?.value) || 0;
                const precio = parseFloat(precioMap[nombre]) || 0;

                const subtotal = precio * cantidad;
                spanSubtotal.textContent = subtotal.toFixed(2);
                total += subtotal;
            });
            totalPedidoSpan.textContent = total.toFixed(2);
        }

        addButton.addEventListener('click', function () {
            const formIndex = parseInt(totalForms.value);
            const newFormHtml = emptyFormHtml.replace(/__prefix__/g, formIndex);
            const tempDiv = document.createElement('tbody');
            tempDiv.innerHTML = newFormHtml;
            formTable.appendChild(tempDiv.firstElementChild);
            totalForms.value = formIndex + 1;
            recalcularTotales();
        });

        formTable.addEventListener('input', recalcularTotales);
        recalcularTotales();
    }
});
</script>
{% endblock %}
